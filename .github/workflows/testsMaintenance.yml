name: Tests Maintenance with Claude

on:
  schedule:
    # Run daily at 7 AM UTC
    - cron: '0 7 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  maintain-tests:
    runs-on: ubuntu-latest
    if: github.repository == 'JetBrains/ideavim'

    permissions:
      contents: write
      pull-requests: write
      id-token: write
      issues: read
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need history for context

      - name: Run Claude Code for Tests Maintenance
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: |
            ## Task: Perform Tests Maintenance

            Your goal is to inspect a random part of the IdeaVim test suite and perform maintenance checks.

            Use the tests-maintenance skill to load the detailed instructions.

            Focus on ONE of these areas per run (pick randomly):
            1. Check disabled tests (@Disabled) - can any be re-enabled?
            2. Review @TestWithoutNeovim annotations - are reasons clear and documented?
            3. Check test content quality - replace meaningless strings with realistic content

            ## Neovim Testing Constraints

            Neovim can only test methods that use functions from VimTestCase. If a test uses
            other API functions (public plugin API like VimPlugin.* or internal API like
            injector.*), it cannot be tested with Neovim because we cannot properly synchronize
            the Neovim state. In these cases, use @TestWithoutNeovim with IDEAVIM_API_USED as
            the skip reason and provide a description of which API is being used.

            ## Important Guidelines

            - Only work on tests, never fix source code bugs
            - Select a small subset of tests (1-3 files) per run
            - Run tests to verify changes don't break anything

            ## Creating Pull Requests

            **Only create a pull request if you made changes.**

            If you made changes, create a PR with:
            - **Title**: "Tests maintenance: <brief description>"
              - Example: "Tests maintenance: Re-enable ScrollTest, add Neovim skip descriptions"
            - **Body** including:
              - What area you inspected
              - Issues you found
              - Changes you made

            If no changes are needed, do not create a pull request.

          # Allow Claude to use necessary tools for test inspection and maintenance
          claude_args: '--allowed-tools "Skill,Read,Edit,Write,Glob,Grep,Bash(git:*),Bash(gh:*),Bash(./gradlew:*),Bash(find:*),Bash(shuf:*)"'
