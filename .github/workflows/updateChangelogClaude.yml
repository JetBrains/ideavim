name: Update Changelog with Claude

on:
  schedule:
    # Run every day at 5 AM UTC
    - cron: '0 5 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    if: github.repository == 'JetBrains/ideavim'

    permissions:
      contents: write
      pull-requests: write
      id-token: write
      issues: read
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to analyze commits and tags
      
      - name: Run Claude Code to Update Changelog
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          prompt: |
            ## Task: Update the CHANGES.md Changelog File
            
            You need to review the latest commits and maintain the changelog file (CHANGES.md) with meaningful changes.
            
            Please follow the detailed changelog maintenance instructions in `.claude/changelog-instructions.md`.
            
            If you find changes that need documenting, update CHANGES.md and create a pull request with:
            - Title: "Update changelog: <super short summary>"
              Example: "Update changelog: Add gn text object, fix visual mode issues"
            - Body: Brief summary of what was added
          
          # Allow Claude to use git, GitHub CLI, and web access for checking releases and tickets
          claude_args: '--allowed-tools "Read,Edit,Bash(git:*),Bash(gh:*),WebSearch,WebFetch(domain:plugins.jetbrains.com),WebFetch(domain:youtrack.jetbrains.com),WebFetch(domain:github.com)"'